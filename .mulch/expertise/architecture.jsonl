{"type":"decision","title":"Agent definition deployment: copy to .overstory/agent-defs/","rationale":"User Claude Code session IS the orchestrator. No separate daemon. CLAUDE.md + hooks + overstory CLI provides integration. Eliminates extra infrastructure.\n\nBase .md files define HOW (reusable agent role). Dynamic overlay CLAUDE.md defines WHAT (task-specific context). Keeps delegation minimal - team leads only pass WHAT, not HOW.\n\nOrchestrator -> team leads -> specialists. Default max depth 2. Prevents runaway spawning. Leads can call overstory sling to spawn sub-workers. Each level crafts system prompts for agents below.\n\nSimple JSON file avoids another SQLite DB for low-frequency writes. Sling writes new sessions, watchdog/status read them. Worktree clean updates state to zombie.\n\nConsistency across jayminwest projects. Separate ci.yml (PRs + push to main, runs lint/typecheck/test) and auto-tag.yml (push to main only, creates git tag + GitHub release on version bump). Uses oven-sh/setup-bun for Bun runtime in GitHub Actions.\n\nDogfood on overstory's own repo first (where agents/ dir exists at project root), then fix external project support, then test on throwaway project. This avoids blocking on the init deployment fix while proving the core lifecycle works.\n\nAgent defs should be git-tracked (not gitignored) so the project is self-contained. This follows the 'state location: in target repo' design principle. Init copies agents/*.md to .overstory/agent-defs/ and sets agents.baseDir accordingly.\n\nTarget 1 coordinator → 4-5 leads → 4-5 builders each = 20-25 concurrent agents. Coordinator at depth 0 does strategic coordination only, leads at depth 1 handle spec-writing and builder management.\n\nReplace fragile JSON file read/write/modify cycles with atomic SQLite operations via SessionStore. Eliminates race conditions from concurrent agent processes writing to sessions.json.\n\nEliminates race conditions from concurrent JSON read-modify-write. SQLite WAL mode provides safe concurrent access from multiple agents.\n\nDuring dogfooding, the global 'overstory-' prefix kill pattern in clean.ts destroyed a live swarm when bun test ran clean.test.ts. The function kills ALL overstory-prefixed tmux sessions regardless of which project they belong to. Either scope the kill to the current project via SessionStore lookup, or encode project identity into tmux session names.\n\nSame Database instance creates both tables, avoiding a separate DB file for run tracking. Both stores use WAL mode and can be opened independently on the same file path.","classification":"foundational","recorded_at":"2026-02-26T16:26:33.510Z","supersedes":["mx-59ed6a","mx-396b5a","mx-1ae0ae","mx-454bf3","mx-3fbe85","mx-399754","mx-a72fd8","mx-2934d8","mx-a843ee","mx-65492d","mx-93f612","mx-c8a347"],"tags":["orchestrator","claude-code","hooks","agents","overlay","delegation","hierarchy","depth","sessions","state"],"id":"mx-a72fd8"}
{"type":"pattern","name":"Layer-by-layer implementation with parallel delegation","description":"Overstory is built in dependency layers (L1 core infra -> L2 agent lifecycle -> L3 merge+orchestration -> L4 watchdog+CLI). Each layer's tasks are independent and can be parallelized across teammates. Close the epic after all subtasks to unblock the next layer. Use beads for tracking: claim all tasks up front, delegate to teammates, close when all pass quality gates.\n\nloadConfig resolves the real project root via git rev-parse --git-common-dir when .overstory/config.yaml is not found at cwd. Critical for any overstory command running inside an agent worktree (hooks call log, mail, prime from worktree cwd).\n\nauto-tag.yml compares package.json version against existing git tags (not previous commit diff). If no tag exists for the current version, it verifies version sync between package.json and src/index.ts, then creates the tag and a GitHub release with auto-generated notes.\n\nWhen fixing many independent bugs in a single session, spawn Task agents in parallel for groups of related issues. Agents share the same working tree, so coordinate staging carefully — each agent stages its files, but the final git add + commit should be done by the orchestrator after all agents complete. Run quality gates once at the end with all changes combined.\n\nParse mulch records for past conflict patterns (resolved/failed, tier, files), build history with tier skip logic (>=2 failures + 0 successes = skip), enrich AI prompts with past successful resolutions, query via fire-and-forget (empty history on failure). Integration: queryConflictHistory() in resolve() after clean-merge failure, skip check wraps each tier.\n\nMulti-provider support uses environment variable injection (ANTHROPIC_BASE_URL, ANTHROPIC_DEFAULT_MODEL) at agent spawn time to allow Claude Code to connect to gateway providers without changing spawn code. Gateway env is resolved by resolveProviderEnv() and passed to tmux session creation.","classification":"foundational","recorded_at":"2026-02-26T16:26:33.511Z","supersedes":["mx-2d03ba","mx-1be20d","mx-2e517a","mx-c64d33","mx-e09f5c","mx-8c2d3d"],"tags":["delegation","parallel","layers","merge-conflict","learning"],"id":"mx-2d03ba"}
{"type":"convention","content":"Runtime state files in .overstory/ (SQLite DBs, logs, worktrees, sessions.json) must be gitignored. Config files (config.yaml, agent-manifest.json, hooks.json) are committed. Follow .beads/ pattern: put .gitignore inside .overstory/ itself so rules are co-located and self-documenting. overstory init should auto-create this file.\n\nTools that create a dotdir (.overstory/, .beads/) should place their .gitignore inside that directory rather than appending to the project root .gitignore. Patterns are relative to the dotdir. Tracked config files (config.yaml, manifest, hooks) stay tracked; runtime state (DBs, logs, sessions, worktrees) gets ignored.\n\nmerge-queue.json is a runtime state file in .overstory/ and must be gitignored by init\n\nPhase 1 batch coordination: 10 issues across 3 initial leads with non-overlapping file areas. Required 4 replacement leads due to early exits. Total: 7 leads, 35 sessions, ~1 hour. Task group auto-close worked correctly. Lesson: prefer 1 lead per issue over batching N issues to 1 lead, since leads reliably complete only their primary task.\n\n.overstory/.gitignore uses wildcard+whitelist pattern: * to ignore all, then !.gitignore, !config.yaml, !agent-manifest.json, !hooks.json, !groups.json, !agent-defs/ to whitelist tracked files. This ensures new runtime files are auto-ignored.\n\nmerge=union gitattribute handling in tryAutoResolve(): checkMergeUnion(repoRoot, filePath) uses 'git check-attr merge -- <file>' and checks if stdout ends with ': merge: union'. If true, resolveConflictsUnion(content) is used instead of resolveConflictsKeepIncoming(content). resolveConflictsUnion keeps BOTH canonical + incoming lines concatenated. git's built-in union driver typically prevents conflict markers (clean merge at Tier 1); the Tier 2 union path is a fallback for edge cases where conflict markers still appear.","classification":"foundational","recorded_at":"2026-02-26T16:26:33.511Z","supersedes":["mx-c266fc","mx-642b5b","mx-e89cfe","mx-0dc049","mx-8e2298","mx-a69115"],"id":"mx-2bd989"}
{"type":"failure","description":"resolveProjectRoot() checked local .overstory/config.yaml before git worktree detection. Since config.yaml is git-tracked, worktrees have their own copy, causing the function to return the worktree path instead of canonical root. This siloed mail.db and other runtime state per worktree.\n\nAgent definition deployment gap: overstory init creates .overstory/ with config and manifest, but does NOT copy agent definition .md files from overstory's agents/ dir. Config sets agents.baseDir='agents' relative to project root, but those files only exist in overstory's repo. Manifest.load() validates ALL agent .md files exist during sling, causing failure in any external project. Root cause: the implementation plan never specified how target projects access agent definitions.\n\noverstory merge fails when builder branches contain out-of-scope commits (e.g. community files). The divergent branch base creates .beads/issues.jsonl conflicts that all resolution tiers fail on.\n\nSQLite migration of merge queue created chicken-and-egg problem: builder changed queue.ts to expect SQLite but left all consumers referencing JSON file path. The merge command itself was broken, blocking merging of the fix.\n\nMulch JSONL files (.mulch/expertise/*.jsonl) cause merge conflicts when multiple agent branches append records. Branches forked before a merge that touches .mulch/ will conflict on re-merge.","resolution":"Reversed check order: git worktree detection runs first. When --git-common-dir resolves to a different root than startDir, we're in a worktree and resolve to the canonical root.\n\nInit should copy agents/*.md to .overstory/agent-defs/ in target project and set agents.baseDir to .overstory/agent-defs.\n\nCherry-pick specific implementation commits onto a clean branch instead of merging the full branch. Spawn a cherry-pick lead with explicit commit SHAs.\n\nAll consumers must be updated in the same commit as the storage backend migration, or the migration must handle both formats during transition. Also: coordinator had to escalate to human to delete the stale runtime file.\n\nMitigations: (1) instruct merge-fix builders to skip mulch record step, (2) fork fix branches from latest main so .mulch base is current, (3) future: implement append-only JSONL merge strategy (union lines instead of conflict).","classification":"foundational","recorded_at":"2026-02-26T16:26:33.511Z","supersedes":["mx-130b6c","mx-0d55fe","mx-b5cf1a","mx-61f2a2","mx-69fdcb"],"tags":["merge","cherry-pick","workaround"],"id":"mx-8ecfe4"}
{"classification":"tactical","recorded_at":"2026-02-26T22:59:40.966Z","tags":["merge-conflict"],"evidence":{"bead":"overstory-7d60"},"type":"pattern","name":"","description":"Merge conflict failed at tier ai-resolve. Branch: overstory/costs-builder/overstory-7d60. Agent: costs-builder. Conflicting files: .","id":"mx-ecd3cf"}
