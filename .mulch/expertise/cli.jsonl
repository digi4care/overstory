{"type":"failure","description":"Claude Code hooks require ALL hook types (SessionStart, Stop, PreCompact) to use {matcher, hooks} wrapper format. Flat [{type, command}] arrays cause validation error, blocking agent startup.","resolution":"Fixed template and init fallback to wrap all hook types in {matcher: '', hooks: [...]} format. Also: must run 'bun link' so overstory CLI is in PATH for tmux-spawned agents.","classification":"tactical","recorded_at":"2026-02-12T16:07:30.473Z","id":"mx-5771cb"}
{"type":"failure","description":"tmux list-sessions #{pid} returns the tmux server PID, shared across all sessions (e.g. 55777 for everything).","resolution":"Use tmux list-panes -t <session> -F '#{pane_pid}' to get the actual process PID running inside a specific pane.","classification":"tactical","recorded_at":"2026-02-12T16:29:38.254Z","id":"mx-17ef66"}
{"type":"failure","description":"init --force strips {{AGENT_NAME}} from hooks.json template producing broken log commands that fail with VALIDATION_ERROR","resolution":"Init must generate orchestrator hooks with explicit '--agent orchestrator' instead of stripping the placeholder to empty string. See overstory-ne0.","classification":"tactical","recorded_at":"2026-02-12T18:11:24.559Z","id":"mx-74f9ae"}
{"type":"failure","description":"AI-resolve tier (tier 3) can corrupt files: claude --print with conflict resolution prompt returns conversational prose instead of code. The resolved content is written to the file without validation, then committed.","resolution":"Need output validation: (1) check output parses as the target language, (2) check it doesn't start with conversational phrases, (3) fall back to tier 4 if validation fails. Filed as overstory-39u P1.","classification":"tactical","recorded_at":"2026-02-12T18:35:59.830Z","id":"mx-bc02ec"}
{"type":"pattern","name":"agent-state-ripple","description":"When adding a new AgentState, ripple the change through all state filters: types.ts (type union), worktree clean (cleanup eligibility), sling (concurrency/uniqueness checks), watchdog daemon (skip terminal states), and status (reconciliation). Missing any of these creates subtle bugs where agents get stuck or miscounted.","classification":"tactical","recorded_at":"2026-02-12T18:41:50.365Z","id":"mx-26c2c6"}
{"type":"failure","description":"sling depth check used >= instead of > for maxDepth comparison, preventing agents from spawning at the deepest allowed depth","resolution":"Changed depth >= maxDepth to depth > maxDepth in sling.ts. The hierarchy is orchestrator(0)->lead(1)->specialist(2), so depth=maxDepth is the allowed leaf.","classification":"tactical","recorded_at":"2026-02-12T18:41:54.039Z","id":"mx-7a623e"}
{"type":"pattern","name":"worktree-absolute-paths","description":"Paths written into agent overlay CLAUDE.md must be absolute, not relative. Worktrees are separate git checkouts that don't have .overstory/ (it's gitignored), so relative paths to .overstory/specs/ or other non-tracked dirs won't resolve. Always use resolve() from node:path before embedding paths in overlays.","classification":"tactical","recorded_at":"2026-02-12T18:41:57.722Z","id":"mx-643490"}
{"type":"pattern","name":"mail-subcommand-addition","description":"When adding new mail subcommands: add store-level method to MailStore interface and implementation in store.ts, add handler function in commands/mail.ts, wire into switch statement, update help text, and update error message listing valid subcommands.","classification":"tactical","recorded_at":"2026-02-12T18:42:04.016Z","id":"mx-034178"}
{"type":"pattern","name":"merge-checkout-skip","description":"Merge resolver must check current branch before git checkout to avoid 'already checked out' error when git worktrees exist. Use git symbolic-ref --short HEAD to detect current branch, skip checkout if already on canonical.","classification":"tactical","recorded_at":"2026-02-12T18:43:20.332Z","id":"mx-19449e"}
{"type":"pattern","name":"ai-resolve-prose-guard","description":"LLM-based conflict resolution (claude --print) can output conversational prose instead of code. Validate output with looksLikeProse() before writing to file — check for common LLM preambles (I, Here, Let me), markdown fencing, and permission requests. Fall through to next tier on detection.","classification":"tactical","recorded_at":"2026-02-12T18:43:23.671Z","id":"mx-174fa5"}
{"type":"failure","description":"mail.ts used raw process.cwd() to locate .overstory/mail.db while all other commands used loadConfig for project root resolution. When agents ran mail commands from worktrees, they opened a separate DB at the wrong location.","resolution":"Exported resolveProjectRoot from config.ts. Updated mailCommand to resolve the project root before opening the DB. Now mail.ts matches the pattern of all other commands.","classification":"tactical","recorded_at":"2026-02-12T19:53:12.704Z","id":"mx-6d6161"}
{"type":"failure","description":"resolveProjectRoot() short-circuits in worktrees because .overstory/config.yaml is a tracked file that exists in every worktree. Mail DB ends up siloed per worktree.","resolution":"Fix: either always use git worktree resolution (skip the existsSync shortcut), or detect worktree paths by checking if cwd contains .overstory/worktrees/. Beads (bd) works correctly by following .git -> gitdir.","classification":"tactical","recorded_at":"2026-02-12T20:11:46.632Z","id":"mx-1ca5bd"}
{"type":"failure","description":"Hook template sed patterns for JSON field extraction assumed no whitespace after colon (\"tool_name\":\"Bash\") but Claude Code sends spaced JSON (\"tool_name\": \"Bash\"). Same bug in hooks-deployer.ts Bash guard command extraction.","resolution":"Use ' *' (zero or more spaces) after colon in all sed JSON extraction patterns, e.g. sed 's/.*\"tool_name\": *\"\\([^\"]*\\)\".*/\\1/'. Applied to hooks.json.tmpl (tool_name) and hooks-deployer.ts (command).","classification":"tactical","recorded_at":"2026-02-13T14:45:39.323Z","id":"mx-4d41d7"}
{"type":"convention","content":"All hooks in templates/hooks.json.tmpl must include ENV_GUARD prefix to ensure hooks only activate for overstory-managed agent sessions. This applies to ALL hook types (SessionStart, UserPromptSubmit, PreToolUse, PostToolUse, Stop, PreCompact), not just generated guards in hooks-deployer.ts.","classification":"tactical","recorded_at":"2026-02-14T04:23:32.747Z","id":"mx-75aea0"}
{"type":"convention","content":"Tmux session names include project name: overstory-{projectName}-{agentName} for project-scoped isolation. Coordinator uses coordinatorTmuxSession(projectName), monitor uses monitorTmuxSession(projectName), supervisor uses overstory-{projectName}-supervisor-{name}. The clean command filters by overstory-{projectName}- prefix in the fallback path.","classification":"tactical","recorded_at":"2026-02-14T04:34:13.792Z","id":"mx-dcd9fa"}
{"type":"pattern","name":"git-commit-bypass-hooks","description":"When pre-commit hooks hang in worktrees, use git plumbing commands: TREE=$(git write-tree) && PARENT=$(git rev-parse HEAD) && COMMIT=$(echo msg | git commit-tree $TREE -p $PARENT) && git update-ref HEAD $COMMIT","classification":"tactical","recorded_at":"2026-02-15T20:38:43.219Z","id":"mx-b3c724"}
{"type":"pattern","name":"Watchdog DI pattern for coordinator","description":"Extend DI interface with _watchdog field {start, stop, isRunning}. Default impl spawns 'overstory watch --background'. Tests inject fakes.","classification":"tactical","recorded_at":"2026-02-15T20:37:26.085Z","id":"mx-672717"}
{"type":"convention","content":"Coordinator commands with daemon integration: use DI interface pattern (_watchdog, _monitor) for testability. Default implementations spawn background processes, fake implementations track call counts for assertions.","classification":"tactical","recorded_at":"2026-02-15T20:37:37.887Z","id":"mx-5adce3"}
{"type":"convention","content":"Git commit in worktrees requires --no-gpg-sign flag when global commit.gpgsign=true is set. Without it, git commit hangs waiting for GPG passphrase (exit code 144). Always use: git commit --no-gpg-sign -m \"message\"","classification":"tactical","recorded_at":"2026-02-15T20:40:08.356Z","id":"mx-01baf1"}
{"type":"pattern","name":"shell-debounce","description":"Shell-based debounce pattern for hooks: store timestamp in file, compare elapsed time, skip if under threshold. Example: DEBOUNCE_FILE=$HOME/.overstory/agents/$AGENT/debounce; NOW=$(date +%s); LAST=$(cat $DEBOUNCE_FILE 2>/dev/null || echo 0); ELAPSED=$((NOW - LAST)); [ $ELAPSED -lt 5 ] && exit 0; echo $NOW > $DEBOUNCE_FILE","classification":"tactical","recorded_at":"2026-02-15T20:40:29.902Z","id":"mx-3c6e48"}
{"type":"convention","content":"When running biome check from within a worktree at .overstory/worktrees/*, biome ignores all files because biome.json excludes .overstory/. Solution: either run biome from canonical root or explicitly pass file paths: bunx biome check <files>","classification":"tactical","recorded_at":"2026-02-16T21:45:01.172Z","id":"mx-7030cc"}
{"type":"failure","description":"makeDeps() in coordinator.test.ts only injected fake monitor/watchdog when explicit config was passed. Tests that omitted monitorConfig fell back to createDefaultMonitor() which calls Bun.spawn(['overstory', ...]), causing ENOENT in CI where overstory CLI is not in PATH.","resolution":"Always inject fake watchdog and monitor in makeDeps(), matching the pattern already used for fake tmux. Changed return type from optional to required for watchdogCalls/monitorCalls.","classification":"tactical","recorded_at":"2026-02-16T22:56:01.514Z","tags":["testing","ci","coordinator"],"id":"mx-30e605"}
{"type":"convention","content":"overstory merge target resolution chain: --into flag > session-branch.txt > config.project.canonicalBranch. Session branch is written by overstory prime at orchestrator startup.","classification":"tactical","recorded_at":"2026-02-17T14:34:53.268Z","id":"mx-be35b8"}
{"type":"convention","content":"Scout-before-builder check uses store.getAll() not getActive(): scouts may have completed (zombie/completed state) before builders are spawned, so we check all session history, not just active sessions.","classification":"tactical","recorded_at":"2026-02-17T15:45:29.013Z","evidence":{"bead":"overstory-smkc"},"id":"mx-f82223"}
{"type":"pattern","name":"dirty-index-blocks-merge","description":"Dirty git index (staged .beads/issues.jsonl) causes all overstory merge operations to fail with 'All enabled resolution tiers failed'. The resolver's tryCleanMerge runs git merge which refuses to merge with uncommitted staged changes. Fix: always run bd sync + git commit before merging agent branches.","classification":"tactical","recorded_at":"2026-02-17T16:15:20.811Z","id":"mx-8b332e"}
{"type":"convention","content":"Commit messages containing literal blocked command text (e.g. 'git push') trigger the Bash PreToolUse guard which scans the full -m flag. Use 'git commit -F <tmpfile>' to pass commit messages that reference blocked operations.","classification":"tactical","recorded_at":"2026-02-18T15:51:46.407Z","evidence":{"bead":"overstory-u8d0"},"id":"mx-7f3b19"}
{"type":"convention","content":"worktree clean safety: isBranchMerged() uses git merge-base --is-ancestor to detect unmerged branches; worktree clean skips unmerged branches by default and requires --force to delete them; JSON output includes skipped array","classification":"tactical","recorded_at":"2026-02-19T00:41:26.201Z","evidence":{"bead":"overstory-6j2o"},"id":"mx-5187b5"}
{"type":"convention","content":"overstory merge fails with JSONL append conflicts when two branches both append to the same .mulch/expertise/*.jsonl file. Workaround: spawn a merger lead to cherry-pick + resolve. Root cause: the tiered resolver (up to ai-resolve) cannot handle concurrent JSONL appends.","classification":"tactical","recorded_at":"2026-02-21T15:21:11.159Z","evidence":{"bead":"overstory-p0uv"},"id":"mx-2a5b37"}
{"type":"failure","description":"merge-queue.db and metrics.db can have task_id vs bead_id schema mismatch when DB was created during a partial rename session. overstory merge and overstory inspect fail.","resolution":"ALTER TABLE RENAME COLUMN task_id TO bead_id on both DBs. Filed overstory-697d for permanent fix.","classification":"tactical","recorded_at":"2026-02-23T19:32:27.131Z","id":"mx-170712"}
{"type":"convention","content":"JSONL append conflicts (issues.jsonl, expertise/*.jsonl) during overstory merge: when both canonical and worktree append lines to JSONL files, use git cherry-pick of the code commit to skip the JSONL conflict rather than resolving the full merge.","classification":"tactical","recorded_at":"2026-02-24T14:10:02.912Z","id":"mx-270b16"}
{"type":"convention","content":"coordinator startCoordinator() preflight pattern: call ensureTmuxAvailable() before createSession() to get a clear error when tmux is not on PATH. After waitForTuiReady() returns false, call isSessionAlive() — throw descriptive AgentError if session died, proceed with warning if session alive but TUI just timed out. CoordinatorDeps._tmux interface must include ensureTmuxAvailable for DI testability.","classification":"tactical","recorded_at":"2026-02-24T15:08:05.719Z","evidence":{"bead":"seeds-f1f9"},"id":"mx-7f9ff0"}
{"type":"failure","description":"coordinator.test.ts silent exit caused by importing isRunningAsRoot from sling.ts which has massive import chain","resolution":"Remove the import and move the test to sling.test.ts","classification":"tactical","recorded_at":"2026-02-24T19:59:57.340Z","outcomes":[{"status":"success","agent":"test-fix-lead"}],"id":"mx-7cb046"}
{"type":"convention","content":"preserveSeedsChanges() pattern in worktree manager: lead agent branches are never merged by the normal pipeline, so .seeds/ issue files would be lost on worktree cleanup. Fix: preserveSeedsChanges(repoRoot, branch, canonicalBranch, agentName) uses three-dot git diff (canonicalBranch...branch -- .seeds/) to extract only .seeds/ changes, writes to temp patch file in .overstory/, applies with git apply --index, commits to canonical branch. On failure, reverts with git reset HEAD -- .seeds/ and git checkout -- .seeds/. Always unlinks temp file in finally. handleClean() skips merge check for lead capability agents and calls preserveSeedsChanges() before removeWorktree().","classification":"tactical","recorded_at":"2026-02-24T21:48:19.132Z","evidence":{"commit":"88100d0"},"outcomes":[{"status":"success","agent":"seeds-preserve-builder"}],"id":"mx-b57901"}
{"type":"failure","description":"Lead agent cannot commit biome formatting fixes in builder worktrees because hooks block git add/commit for lead agents.","resolution":"Note uncommitted fixes in merge_ready mail for coordinator to handle post-merge. Alternatively nudge builder to fix before its session ends.","classification":"tactical","recorded_at":"2026-02-24T23:54:30.820Z","outcomes":[{"status":"success","agent":"source-alias-lead"}],"id":"mx-7ff621"}
{"type":"convention","content":"waitForTuiReady() two-phase readiness check (overstory-88e6 + overstory-5579): Phase 1 detects prompt indicator (❯ or 'Try \"'), Phase 2 detects status bar ('bypass permissions' or 'shift+tab'). Returns true only when BOTH phases observed. Additionally detects workspace trust dialog ('trust this folder') and auto-confirms with sendKeys(name, ''), with trustHandled flag preventing duplicate Enter sends. This replaces the single-phase prompt-only check that was unreliable because Claude Code renders the prompt before the input handler attaches.","classification":"tactical","recorded_at":"2026-02-25T15:11:21.193Z","evidence":{"bead":"overstory-88e6"},"outcomes":[{"status":"success","agent":"tui-ready-lead"}],"id":"mx-4520ac"}
{"type":"pattern","name":"phased-lead-dispatch","description":"Phased lead dispatch for sequential file dependencies: when multiple issues touch the same files (e.g., sling.ts), dispatch in phases — Phase 1 leads run in parallel on independent work, then merge; Phase 2 leads branch from updated main with Phase 1 changes. This avoids merge conflicts while maximizing parallelism.","classification":"tactical","recorded_at":"2026-02-25T22:42:44.849Z","id":"mx-afe435"}
{"type":"pattern","name":"lead-partial-completion","description":"Lead session length management: leads assigned 2+ sequential issues may only complete the first before session ends. Monitor for partial completion and dispatch a new lead for remaining issues rather than waiting. In spawn-control-batch, spawn-features handled pb1p but e9my needed a separate dispatch-overrides lead.","classification":"tactical","recorded_at":"2026-02-25T22:42:46.069Z","id":"mx-3707f7"}
{"type":"convention","content":"Dynamic import pattern to bypass tsc static resolution of @os-eco/mulch-cli (overstory-dc80): When a dependency ships raw .ts source files, static imports cause tsc to follow into node_modules and apply strict settings (noUncheckedIndexedAccess) to the dependency's internals, causing spurious type errors. Fix: store the package name in a variable (const MULCH_PKG = '@os-eco/mulch-cli') and use 'await import(MULCH_PKG)' instead of a top-level import. tsc cannot statically resolve variable-based specifiers, so it skips type-checking the dependency. Define the needed types locally to avoid any import from the package.","classification":"tactical","recorded_at":"2026-02-25T23:29:59.540Z","outcomes":[{"status":"success","agent":"mulch-api-fix-builder"}],"id":"mx-51c7e4"}
{"type":"pattern","name":"pi-agent-end-handler","description":"Pi guard extension agent_end handler: Pi's agent_end event fires when the agentic loop completes (task done), before session_shutdown. Without it, completed Pi agents stay in working state and get watchdog-escalated. session_shutdown is kept as a safety net for Ctrl+C/crash/force-kill.","classification":"tactical","recorded_at":"2026-02-26T18:01:13.294Z","evidence":{"bead":"overstory-b64f"},"id":"mx-6b41a7"}
{"type":"convention","content":"biome check in worktrees: run from worktree root (not canonical repo root) with explicit file paths to bypass the canonical biome.json's .overstory ignore rule: bunx biome check src/...","classification":"tactical","recorded_at":"2026-02-26T18:32:40.119Z","outcomes":[{"status":"success","agent":"pricing-builder"}],"id":"mx-23d0e5"}
{"type":"convention","content":"Runtime-aware transcript discovery pattern (overstory-7d60): use getTranscriptDir(runtimeId, projectRoot) switch to resolve per-runtime transcript dirs, then pass runtimeId through discoverOrchestratorTranscript(). Import getRuntime() from runtimes/registry.ts and call getRuntime(undefined, config) to get the default runtime for --self flag.","classification":"tactical","recorded_at":"2026-02-26T22:54:06.647Z","outcomes":[{"status":"success","agent":"costs-builder"}],"id":"mx-e1e635"}
