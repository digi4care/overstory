{"type":"pattern","name":"bun:sqlite Synchronous Pattern","description":"bun:sqlite is synchronous. Use Database class from 'bun:sqlite'. Enable WAL mode: db.exec('PRAGMA journal_mode=WAL'). Set busy_timeout: db.exec('PRAGMA busy_timeout=5000'). Use db.prepare() for prepared statements. db.query().all() for SELECT, db.run() for INSERT/UPDATE. No async/await needed for DB ops.","classification":"foundational","recorded_at":"2026-02-12T15:24:35.750Z","tags":["sqlite","database","sync"],"id":"mx-a64ac9"}
{"type":"convention","content":"All JSON files written via Bun.write must include a trailing newline: `${JSON.stringify(data, null, '\\t')}\\n`. Biome enforces trailing newlines, and omitting them causes lint failures on generated/runtime files like sessions.json. Apply consistently across all write sites — grep for JSON.stringify to find them all.","classification":"tactical","recorded_at":"2026-02-12T16:47:21.468Z","id":"mx-24764f"}
{"type":"failure","description":"bun:test mock.module() is process-global and leaks across all test files run in the same bun test invocation. Mocking a module like ../src/config.ts in one test file causes other test files that import the same module to get the mocked version, causing 73+ test failures.","resolution":"Avoid mock.module entirely; instead extract testable pure functions or use spyOn for instance methods.","classification":"tactical","recorded_at":"2026-02-12T16:53:02.407Z","id":"mx-56558b"}
{"type":"pattern","name":"macOS temp dir symlink resolution for git worktree tests","description":"macOS temp dir symlink: /var/folders -> /private/var/folders. Git resolves symlinks in worktree paths, so when creating temp git repos for tests, wrap the path with realpathSync() to avoid path comparison mismatches. This affects listWorktrees output and any path-based lookups like removeWorktree branch resolution.","classification":"tactical","recorded_at":"2026-02-12T17:05:33.398Z","id":"mx-4a865b"}
{"type":"pattern","name":"bd CLI JSON normalization","description":"bd show --json returns an array (not single object), and uses 'issue_type' field name instead of 'type'. Client must unwrap array for show() and map issue_type->type via normalizeIssue(). Integration tests exposed these mismatches that mocks hid.","classification":"tactical","recorded_at":"2026-02-12T17:08:58.843Z","id":"mx-6e9fbd"}
{"type":"pattern","name":"Bun test.skipIf needs synchronous check","description":"bun:test test.skipIf(condition) evaluates condition at test registration time (synchronously), not at runtime. Use Bun.spawnSync for CLI availability checks, not Bun.spawn in beforeAll. beforeAll runs after test registration, so async availability checks are too late for skipIf.","classification":"tactical","recorded_at":"2026-02-12T17:09:05.059Z","id":"mx-37178b"}
{"type":"pattern","name":"Selective Bun.spawn spy for testing","description":"Save original Bun.spawn before spying, define a selectiveMock function with (...args: unknown[]): unknown signature that branches on cmd[0], then cast with mockImplementation(selectiveMock as typeof Bun.spawn). This avoids TypeScript overload errors while allowing real subprocess calls to pass through.","classification":"tactical","recorded_at":"2026-02-12T17:12:42.892Z","id":"mx-2173bf"}
{"type":"pattern","name":"Delete/modify conflicts for testing tier escalation","description":"To test resolver tiers beyond auto-resolve with real git: create a delete/modify conflict (delete file on one branch, modify on other). Git reports it as unmerged but produces NO conflict markers in the working copy, causing resolveConflictsKeepIncoming to return null. This naturally escalates past Tier 2. For Tier 4 (reimagine), use a separate file in entry.filesModified that exists on both branches, since git show fails for deleted files.","classification":"tactical","recorded_at":"2026-02-12T17:12:51.278Z","id":"mx-d12879"}
{"type":"pattern","name":"Template clone for test repos","description":"Cache a template git repo on first call (lazy singleton), then use git clone for subsequent repos (1 subprocess instead of 5). Avoid --local flag on macOS — hardlinks trigger EFAULT in Bun rm(). Use GIT_AUTHOR/COMMITTER env vars instead of per-repo git config to eliminate 2 more subprocess spawns.","classification":"tactical","recorded_at":"2026-02-12T17:30:44.943Z","id":"mx-5ab720"}
{"type":"failure","description":"git init without -b main causes branch name mismatches between macOS (main) and Linux CI (master).","resolution":"Always pass -b main to git init in test helpers to ensure consistent branch naming across platforms.","classification":"tactical","recorded_at":"2026-02-12T20:15:14.057Z","id":"mx-e58f95"}
{"type":"pattern","name":"test-infinite-loop-isolation","description":"When testing commands that start infinite loops (like dashboard polling), use process.chdir to a temp dir WITHOUT required config files so initialization throws BEFORE the loop starts. This proves validation passed while preventing background loops from leaking across test files. Promise.race abandons promises but doesn't stop running code.","classification":"tactical","recorded_at":"2026-02-13T16:53:43.914Z","id":"mx-9d7dba"}
{"type":"failure","description":"Dashboard tests starting infinite poll loops via Promise.race leak loops after test completes. Abandoned promise's loop continues writing to stdout, polluting subsequent test files.","resolution":"chdir to a temp dir without .overstory/config.yaml so loadConfig() throws before entering the while loop. Prevents infinite loop from ever starting.","classification":"tactical","recorded_at":"2026-02-13T16:55:34.758Z","id":"mx-3ba5b0"}
{"type":"pattern","name":"ci-git-identity-config","description":"CI test repos need repo-level git config (user.name/email) because resolver's runGit doesn't pass GIT_TEST_ENV and CI runners lack global git identity. Fix: set config in createTempGitRepo().","classification":"tactical","recorded_at":"2026-02-13T18:40:48.816Z","id":"mx-a61ea1"}
{"type":"pattern","name":"bun-spy-mock-clear","description":"bun v1.3.9+ test reporter may flush output through console.log/error between spy creation and test action, inflating call counts. Always call mockClear() after spyOn() before the assertion-triggering action.","classification":"tactical","recorded_at":"2026-02-13T18:40:53.673Z","id":"mx-a30b79"}
{"type":"failure","description":"'Never mock what you can use for real' has a critical exception: tests calling killAllTmuxSessions() or other global-state-mutating functions MUST mock those operations. Real tmux kills during bun test destroyed a live agent swarm.","resolution":"The philosophy applies to isolated resources (temp dirs, :memory: DBs) but NOT to shared global resources (tmux server, process table). Add tmux mocking to clean.test.ts.","classification":"tactical","recorded_at":"2026-02-14T04:14:07.638Z","id":"mx-7aee0a"}
{"type":"pattern","name":"pathExists helper","description":"Use stat() from node:fs/promises for both files and directories. Bun.file().exists() only works for files, not directories. Pattern: async function pathExists(path: string): Promise<boolean> { try { await stat(path); return true; } catch { return false; } }","classification":"tactical","recorded_at":"2026-02-15T20:54:54.676Z","id":"mx-194ff2"}
{"type":"pattern","name":"Path normalization for symlinks","description":"When comparing file paths from different sources (git worktree list, SessionStore, file system), use realpathSync() to normalize symlinks before comparison. On macOS, /tmp -> /private/tmp causes mismatches without normalization. Wrap in try/catch since realpathSync throws for non-existent paths.","classification":"tactical","recorded_at":"2026-02-15T20:49:35.187Z","id":"mx-79fa68"}
{"type":"convention","content":"Test git repo setup: Always disable GPG signing in test git repos with 'git config commit.gpgsign false' to prevent test failures from GPG configuration.","classification":"tactical","recorded_at":"2026-02-15T20:49:35.753Z","id":"mx-913aa9"}
{"type":"convention","content":"Mail test pattern for repeated checks: When testing mail check multiple times, must send new messages between checks since check/checkInject mark messages as read. Use separate client.send() calls to create fresh unread messages for each test assertion.","classification":"tactical","recorded_at":"2026-02-15T20:43:46.704Z","id":"mx-9f4650"}
{"type":"pattern","name":"Dependency Injection for Test Isolation","description":"Instead of mock.module() (which leaks across tests), define optional deps parameter on functions and pass mock implementations. Example: checkConsistency(config, dir, deps?) where deps = {listSessions, isProcessAlive}. Tests create mocks and pass via deps param. This prevents module-level mock leakage.","classification":"tactical","recorded_at":"2026-02-15T22:20:35.829Z","id":"mx-2412b2"}
{"type":"failure","description":"agents.test.ts had process.chdir(tempDir) in beforeEach but never restored originalCwd in afterEach, leaving the Bun test process with a deleted temp dir as cwd. This poisoned subsequent test files in the same worker — 6 tests in prime.test.ts and color.test.ts failed only in CI due to test file ordering.","resolution":"Always save and restore originalCwd when using process.chdir in tests. Subprocess tests using cwd: process.cwd() with relative imports are fragile — use absolute paths derived from import.meta.dir instead. These bugs are invisible locally since they depend on Bun test file ordering.","classification":"tactical","recorded_at":"2026-02-17T03:08:40.580Z","tags":["process.chdir","test-isolation","ci-only-failure","bun-test"],"id":"mx-f4756f"}
{"type":"convention","content":"When adding a required field to OverstoryConfig, ALL test fixtures across the codebase (src/agents/manifest.test.ts, src/doctor/*.test.ts) must be updated to include the new field — this is a cross-cutting concern that affects files outside any single builder's scope. Consider making new OverstoryConfig fields optional or assigning fixture updates to a separate task when doing batch coordination.","classification":"tactical","recorded_at":"2026-02-19T20:32:39.688Z","evidence":{"bead":"overstory-ip89"},"id":"mx-9e8470"}
